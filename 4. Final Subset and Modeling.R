train = read.csv('test_meanEncodingNew.csv', stringsAsFactors = F)
test = read.csv('train_meanEncodingNew.csv', stringsAsFactors = F)
df = subset(rbind(train, test), select = -X) # remove index column
attach(df)

# define training data indexes
train_rows = c(1:100000)

# convert data frame to matrix for modeling
x = model.matrix(HasDetections~.-1, data = df[train_rows,])
y = df[train_rows,]$HasDetections
x.test = model.matrix(HasDetections~.-1, data = df[-train_rows,])
y.test = df[-train_rows,]$HasDetections


### Lasso subset selection
set.seed(1)
cv.lasso = cv.glmnet(x, y)
coef(cv.lasso)


### Random forest

# Change response variables to factor levels
df$Response = as.factor(HasDetections)
df.subset = subset(df, select = c('EngineVersion',
                                  'AVProductsInstalled',
                                  'OrganizationIdentifier',
                                  'GeoNameIdentifier',
                                  'LocaleEnglishNameIdentifier',
                                  'Processor.x64',
                                  'OsSuite.768',
                                  'OsPlatformSubRelease',
                                  'IsProtected',
                                  'SmartScreen.RequireAdmin',
                                  'Census_MDC2FormFactor',
                                  'Census_OEMNameIdentifier',
                                  'Census_OEMModelIdentifier',
                                  'Census_ProcessorCoreCount',
                                  'Census_PrimaryDiskTotalCapacity',
                                  'Census_PrimaryDiskTypeName.others',
                                  'Census_PrimaryDiskTypeName.SSD',
                                  'Census_TotalPhysicalRAM',
                                  'Census_ChassisTypeName.Notebook',
                                  'Census_ChassisTypeName.others',
                                  'Census_OSBuildNumber',
                                  'Census_OSSkuName.CORE_SINGLELANGUAGE',
                                  'Census_OSInstallTypeName',
                                  'Census_OSWUAutoUpdateOptionsName.Notify',
                                  'Census_OSWUAutoUpdateOptionsName.UNKNOWN',
                                  'Census_ActivationChannel.Retail',
                                  'Census_ActivationChannel.Volume.GVLK',
                                  'Census_IsSecureBootEnabled',
                                  'Census_IsAlwaysOnAlwaysConnectedCapable',
                                  'Wdft_IsGamer',
                                  'AppVersion',
                                  'AvSigVersion',
                                  'AVProductStatesIdentifier',
                                  'CountryIdentifier',
                                  'CityIdentifier',
                                  'Census_ProcessorModelIdentifier',
                                  'Census_OSVersion',
                                  'Census_FirmwareVersionIdentifier',
                                  'Response'))

# build random forest
set.seed(101)
rf.train = randomForest(Response~., data = df.subset, subset = train_rows, importance = T)
rf.train

# predict with test data
rf.class.pred = predict(rf.train, df.subset[-train_rows,])
with(df.subset[-train_rows,], table(rf.class.pred, Response)) # confusion matrix

# get variable importance
as.data.frame(importance(rf.train)) %>%
  mutate(FeatureName = row.names(as.data.frame(importance(rf.train)))) %>%
  arrange(desc(MeanDecreaseGini))

# get AUC
preds = as.numeric(rf.class.pred)
res = as.numeric(df.subset[-train_rows,]$Response)
auc(res, preds)