library(readr)
library(data.table)
library(caret)
library(dplyr)
selectedData <- read_csv("~/Desktop/DSO530 Applied Modern Statistical Learning Methods/Final Project/train_forEncoding.csv")
test_selectedData <- read_csv("~/Desktop/DSO530 Applied Modern Statistical Learning Methods/Final Project/test_forEncoding.csv")


prop.table(table(selectedData$HasDetections))

n = colSums(is.na(selectedData) > 0) 
m = colSums(selectedData == '', na.rm = T)
(m+n) / 100000


nTest = colSums(is.na(test_selectedData) > 0) 
mTest = colSums(test_selectedData == '', na.rm = T)
(nTest+mTest) / 100000

#checked all variables in "missingTooMany" and used domain knowledge 
missingTooMany = which((m+n) / 100000 > 0.4)
missingTooMany

missingTooManyTest = which((nTest+mTest) / 100000 > 0.4)
missingTooManyTest 

selectedData1 = subset(selectedData, select = -MachineIdentifier)
test_selectedData1 = subset(test_selectedData, select = -MachineIdentifier)
y = selectedData$HasDetections

feature <- names(selectedData1)
feature
categorical <- c()
categorical_ind <- c()

for (f in colnames(selectedData1))
  if (is.character(selectedData1[[f]])|grepl(".Identifier", f)>0 )#Check is.character or include 
    {categorical <- c(categorical, f) # Store the feature name
    categorical_ind <- c(categorical_ind, which(colnames(selectedData1)==f))} #Store the column number of those fe

##21 categorical variables
categorical

##check how many unique values in each column to decide dummy / frequency encoding
uniquevalues <- c()
for (f in categorical_ind){uniquevalues <- c(uniquevalues, length(unique(selectedData1[[f]])))}
uniquevalues

lessLevel = which(uniquevalues < 7)
moreLevel = which(uniquevalues >= 7)

categorical[moreLevel]

## mean encoding for train and test data
selectedData2 = selectedData1
test_selectedData2 = test_selectedData1

for (i in moreLevel){
  col = data.frame("predictor" = selectedData1[[categorical_ind[i]]], "target" = y)
  colTest = data.frame("predictor" = test_selectedData1[[categorical_ind[i]]])
  
  lookup = col %>%
    group_by(predictor) %>%
    summarize(mean_target = mean(target))
  
  col = left_join(col, lookup)
  colTest = left_join(colTest, lookup)
  
  selectedData2[[categorical_ind[i]]] = col$mean_target
  test_selectedData2[[categorical_ind[i]]] = colTest$mean_target
}

str(selectedData2)


##dummy coding for train and test data
categorical[lessLevel]

selectedData3 = selectedData2
test_selectedData3 = test_selectedData2

for (i in lessLevel){
  col <- data.frame("predictor" = selectedData2[[categorical[i]]], "target" =y)
  colTest <- data.frame("predictor" = test_selectedData3[[categorical[i]]], "target" = 0)
  
  col$predictor = as.factor(col$predictor)
  colnames(col) <- c(categorical[i], "target")
  colnames(colTest) <- c(categorical[i], "target")
  
  dummy.var = dummyVars(~ ., data = col, fullRank = TRUE)
  col.dummy = predict(dummy.var, newdata = col)
  colTest.dummy = predict(dummy.var, newdata = colTest)
  
  j = which(colnames(selectedData3) == categorical[i])
  selectedData3 = cbind(selectedData3[,1:(j-1)], col.dummy, selectedData3[, (j+1):dim(selectedData3)[2]])
  test_selectedData3 = cbind(test_selectedData3[,1:(j-1)], colTest.dummy, test_selectedData3[,(j+1):dim(test_selectedData3)[2]])
  
  selectedData3 = subset(selectedData3, select = -target)
  test_selectedData3 = subset(test_selectedData3, select = -target)
  #selectedData1 = subset(selectedData, select = -MachineIdentifier)
  #test_selectedData1 = subset(test_selectedData, select = -MachineIdentifier)
}

#selectedData4 = selectedData3[, -"ProductName"]
#test_selectedData4 = test_selectedData3[,"ProductName"]

str(selectedData3)

## Near Zero Variance removal 
zeroVar = nearZeroVar(selectedData3, saveMetrics = TRUE)
zeroVar[,3:4]

zeroVarCols = nearZeroVar(selectedData3)

selectedData4 = subset(selectedData3, select = -zeroVarCols)
test_selectedData4 = subset(test_selectedData3, select = -zeroVarCols)

str(selectedData4)

# Median Impute N/A

pre.impute = preProcess(selectedData4, method = "medianImpute")
selectedData5 = predict(pre.impute, selectedData4)
test_selectedData5 = predict(pre.impute, test_selectedData4)

str(selectedData5)

nn = colSums(is.na(selectedData5)>0)
mm = colSums(selectedData5 == '', na.rm=T)
mm + nn

nn = colSums(is.na(test_selectedData5)>0)
mm = colSums(test_selectedData5 == '', na.rm=T)
mm + nn


# save as outputs

write.csv(selectedData5, file = "~/Desktop/DSO530 Applied Modern Statistical Learning Methods/Final Project/train_meanEncoding.csv")
write.csv(test_selectedData5, file = "~/Desktop/DSO530 Applied Modern Statistical Learning Methods/Final Project/test_meanEncoding.csv")


