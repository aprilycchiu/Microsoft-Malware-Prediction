library(tree)
library(randomForest)
library(dplyr)

train = read.csv("~/Desktop/DSO530 Applied Modern Statistical Learning Methods/Final Project/train_meanEncoding.csv")
test = read.csv("~/Desktop/DSO530 Applied Modern Statistical Learning Methods/Final Project/test_meanEncoding.csv")
train = subset(train, select = -X)
test = subset(test, select = -X)

train$HasDetections = as.character(train$HasDetections)
train$HasDetections = as.factor(train$HasDetections)
test$HasDetections = as.character(test$HasDetections)
test$HasDetections = as.factor(test$HasDetections)

library(leaps)

SubsetSelect=regsubsets(HasDetections~., train)
summary(SubsetSelect)

SubsetSelect8=regsubsets(HasDetections~., data=train, nvmax=8)
Summary = summary(SubsetSelect8)
names(Summary)

plot(Summary$rss,xlab="Number of Variables",ylab="RSS",
     type="l")
plot(Summary$adjr2,xlab="Number of Variables",
     ylab=" Adjusted RSq",type="l")
which.max(Summary$adjr2)

coef(SubsetSelect8,8)

### Best subset selection

train.subset = subset(train, select = c('EngineVersion',
                                        'AVProductsInstalled',
                                        'GeoNameIdentifier',
                                        'OsSuiteIdentifier.768',
                                        'IsProtected',
                                        'SmartScreen.RequireAdmin',
                                        'Census_OEMModelIdentifier',
                                        'Wdft_IsGamer',
                                        'HasDetections'))

test.subset = subset(test, select = c('EngineVersion',
                                      'AVProductsInstalled',
                                      'GeoNameIdentifier',
                                      'OsSuiteIdentifier.768',
                                      'IsProtected',
                                      'SmartScreen.RequireAdmin',
                                      'Census_OEMModelIdentifier',
                                      'Wdft_IsGamer',
                                      'HasDetections'))

rf.train = randomForest(HasDetections~., data = train.subset, ntree = 500, 
                        nodesize = 10, mtry = 3, importance = TRUE)
rf.train

rf.class.pred = predict(rf.train, test.subset)
with(test.subset, table(rf.class.pred, HasDetections))

(29351+30864)/100000

importance(rf.train)


### Forward and Backward Stepwise Selection

regfit.fwd = regsubsets(HasDetections~.,data=train , nvmax = 40, method = "forward")
reg.summary.fwd = summary(regfit.fwd)
plot(reg.summary.fwd$rss, xlab = "Number of Variables", ylab = "RSS", type = "l")
plot(reg.summary.fwd$adjr2 ,xlab="Number of Variables",
     ylab="Adjusted RSq",type="l")
Max = which.max(reg.summary.fwd$adjr2)   # the maximum point of vector
points(Max, reg.summary.fwd$adjr2[Max], col="red", cex=2, pch=20) 

regfit.bwd = regsubsets(HasDetections~.,data=train , nvmax = 40, method = "backward")
reg.summary.bwd = summary(regfit.bwd)
plot(reg.summary.bwd$adjr2 ,xlab="Number of Variables",
     ylab="Adjusted RSq",type="l")
Max = which.max(reg.summary.bwd$adjr2)   # the maximum point of vector
points(Max, reg.summary.bwd$adjr2[Max], col="red", cex=2, pch=20) 

coef(regfit.fwd ,30)   # the coefficient estimates
coef(regfit.bwd ,30)   # the coefficient estimates


train.subset = subset(train, select = c('EngineVersion',
                                        'EngineVersionS',
                                        'AVProductsInstalled',
                                        'OrganizationIdentifier',
                                        'GeoNameIdentifier',
                                        'LocaleEnglishNameIdentifier',
                                        'Processor.x64',
                                        'OsPlatformSubRelease',
                                        'OsSuiteIdentifier.768',
                                        'SkuEdition.Pro',
                                        'Census_MDC2FormFactor',
                                        'IsProtected',
                                        'SmartScreen.RequireAdmin',
                                        'Census_OEMNameIdentifier',
                                        'Census_OEMModelIdentifier',
                                        'Census_PrimaryDiskTypeName.others',
                                        'Census_PrimaryDiskTypeName.SSD',
                                        'Census_ChassisTypeName.Desktop',
                                        'Census_ChassisTypeName.Notebook',
                                        'Census_InternalPrimaryDisplayResolutionHorizontal',
                                        'Census_InternalPrimaryDisplayResolutionVertical',
                                        'Census_OSBuildNumberIdentifier',
                                        'Census_OSSkuName.CORE_SINGLELANGUAGE',
                                        'Census_OSInstallTypeName',
                                        'Census_OSWUAutoUpdateOptionsName.UNKNOWN',
                                        'Census_ActivationChannel.Volume.GVLK',
                                        'Census_IsSecureBootEnabled',
                                        'Wdft_IsGamer',
                                        'HasDetections'))

test.subset = subset(test, select = c('EngineVersion',
                                      'EngineVersionS',
                                      'AVProductsInstalled',
                                      'OrganizationIdentifier',
                                      'GeoNameIdentifier',
                                      'LocaleEnglishNameIdentifier',
                                      'Processor.x64',
                                      'OsPlatformSubRelease',
                                      'OsSuiteIdentifier.768',
                                      'SkuEdition.Pro',
                                      'Census_MDC2FormFactor',
                                      'IsProtected',
                                      'SmartScreen.RequireAdmin',
                                      'Census_OEMNameIdentifier',
                                      'Census_OEMModelIdentifier',
                                      'Census_PrimaryDiskTypeName.others',
                                      'Census_PrimaryDiskTypeName.SSD',
                                      'Census_ChassisTypeName.Desktop',
                                      'Census_ChassisTypeName.Notebook',
                                      'Census_InternalPrimaryDisplayResolutionHorizontal',
                                      'Census_InternalPrimaryDisplayResolutionVertical',
                                      'Census_OSBuildNumberIdentifier',
                                      'Census_OSSkuName.CORE_SINGLELANGUAGE',
                                      'Census_OSInstallTypeName',
                                      'Census_OSWUAutoUpdateOptionsName.UNKNOWN',
                                      'Census_ActivationChannel.Volume.GVLK',
                                      'Census_IsSecureBootEnabled',
                                      'Wdft_IsGamer',
                                      'HasDetections'))


